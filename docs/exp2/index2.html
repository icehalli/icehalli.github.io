<!DOCTYPE html>
<html>
<head>
<title>Page Title</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link href="../styles/site.css" rel="stylesheet">
</head>
<body>
  
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.2/markdown-it.min.js" integrity="sha512-ohlWmsCxOu0bph1om5eDL0jm/83eH09fvqLDhiEdiqfDeJbEvz4FSbeY0gLJSVJwQAp0laRhTXbUQG+ZUuifUQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it-emoji/3.0.0/markdown-it-emoji.min.js" integrity="sha512-oEGO1WEAe1nZqI4pvhThiGh3IPUKfmelFhGR0PEOwv9kecA/dJ6FA67Qq8H6T+p/e4rh+lx2T3X7FnWVbYM1DA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.8/handlebars.min.js" integrity="sha512-E1dSFxg+wsfJ4HKjutk/WaCzK7S2wv1POn1RRPGh8ZK+ag9l244Vqxji3r6wgz9YBf6+vhQEYJZpSjqWFPg9gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    $(document).ready(function(){
        ready();
    });

    function ready(){
        var start = {body: {tmpl: 'page.html', content: null}};
        _ComponentLoader.getDataByKey(start, Object.keys(start));
        //getData(start);

    }

    class _ComponentLoader {
        static getData(toget) {
            var getKeys = Object.keys(toget);
            _ComponentLoader.getDataByKey(toget, getKeys);
        }
        static getDataByKey(toget, keys){
            if(keys.length === 0)
                return;
            var k = keys[0];
            keys.shift();
            var item = toget[k];
            console.log(item);
            get(item.tmpl, (dataTmpl) => {
                    console.log('dataTmpl', dataTmpl);
                if(item.content === null) {
                    var next = _ComponentLoader.Load(k, dataTmpl);
                    console.log('next', next);
                    if(next)
                        _ComponentLoader.getData(next);
                    else
                        _ComponentLoader.getDataByKey(toget, keys);
                }
                else {
                    get(item.content, (dataContent) => {
                        console.log('dataContent', dataContent);
                        var next = _ComponentLoader.Load(k, dataTmpl, dataContent);
                        console.log('next', next);
                        if(next)
                            _ComponentLoader.getData(next);
                        else
                            _ComponentLoader.getDataByKey(toget, keys);
                    });
                }
            });
        }
        static applyTemplate(tmpl, data) {
            console.log('applyTemplate', tmpl, data);
            var template = Handlebars.compile(tmpl);
            var res = template(data);
            console.log('tmplres', res);
            return res;
        }

        static Load(parent, data, content){      
            var layout = $('<div>');
            layout.html(data);
            var divs = layout.find("*[id]");
            console.log('Load', parent, divs.length, data, content);  
            console.log('divs', divs.length);
            if(divs.length === 0){
                if(content){
                    data = _ComponentLoader.applyTemplate(data, content);
                }
                if(parent === 'body')            
                    $(parent).append(data);//if content merge content with data
                else
                    $(parent).html(data);//if content merge content with data
                return null;
            }
            var childrenElements = {};
            var templateUrl = '';
            var contentUrl = '';
            divs.each((i, el) => {
                var element = $(el);
                var id = element.attr('id');
                if(id) {
                    childrenElements['#'+id] = {tmpl: id+'.html', content: id+'.json'};
                }
                console.log(element);
                if(parent === 'body')            
                    $(parent).append(element);
                else
                    $(parent).html(element);//if content merge content with data
            });
            return childrenElements;
        }
    }

    
    function MockLayout() {
        return `<div id="nav">nav</div>
<div id="header">header</div>
<div id="content">content</div>`;
    }
    function MockLayoutJson() {
        return {
            nav: {
                id: 'nav',
                tmpl: 'nav.html',
                content: 'nav.json'
            },
            header: {
                id: 'header',
                tmpl: 'header.html',
                content: 'header.json'
            },
            content: {
                id: 'content',
                tmpl: 'content.html',
                content: 'content.json'
            },
        };
    }

    function MockHeaderHtml(){
        return '<span>MockHeaderHtml</span>'
    }
    function MockContentHtml(){
        return '<span>{{data}}</span>'
    }
    function MockHeaderJson(){
        return {
            data: 'MockHeaderJson'
        }
    }
    function MockContentJson(){
        return {
            data: 'MockContentJson'
        }
    }
    function MockNavlisHtml(){
        return `{{#each tabs}}<li class="nav-item">
          <a class="nav-link active" data-url="{{tabs.url}}" aria-current="page" href="{{tabs.url}}">{{tabs.label}}</a>
        </li>{{/each}}`;
    }
    // function MockNavlisJson(){
    //     return {
    //         data: 'MockNavlisJson'
    //     }
    // }
    function MockNavHtml(){
        return `
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
    <a class="navbar-brand" href="{{url}}">{{home}}</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse">
      <ul noid='navlis' class="navbar-nav">
        {{#each tabs}}
        <li class="nav-item">
          <a class="nav-link active" data-url="{{this.url}}" aria-current="page" href="{{this.url}}">{{this.label}}</a>
        </li>
        {{/each}}
      </ul>
    </div>
  </div>
</nav>`;
    }

    function MockNavJson(){
        return {
            home: 'home',
            url: '#',
            tabs: [
                {
                    label: 'hello',
                    url: 'mbl.is'
                },
                {
                    label: 'hello2',
                    url: 'mbl.is'
                }
            ]
        }
    }

    function get(url, cb){
        _Ajax.get(url, function(data){
            cb(data);
        });
    }
class _Ajax {
    static getInFolder(url, cb) {
        if(_Config.isMock)
            this.get(url,cb);
        else
            this.get(_Config.folder + '/' + url);
    }
    
    static getAsync = async(url, fallbackData) => {
        // const response = await fetch(url);
        // console.log(response);
        let json;

        try {
            const response = await fetch(url);
            json = await response.json();
        } catch (error) {
            if (error instanceof SyntaxError) {
                // Unexpected token < in JSON
                console.log('There was a SyntaxError', error);
            } else {
                console.log('There was an error', error);
            }
            if(fallbackData) {
                const data = fallbackData();
                console.log('Using fallback data', data);
                json = data;
            }
            else
                json = {fail:true, err};
        }

        if (json) {
            console.log('Valid response', json);
        }
        return json;
    }

    static getdd(url, cb, fallbackData) {
        console.log('_Ajax.get', url)
        fetch(url)
            .then((response) => response.json(), (err) => {
                console.error(`Getting ${url}`);
                if(fallbackData) {
                    const data = fallbackData();
                    console.log('Using fallback data', data);
                    cb(data);
                }
                else
                    cb({fail:true, err});
            })
            .then((json) => {
                cb(json);
            });
    }

    
    static get(url, cb, fallbackData) {
        console.log('_Ajax.get', url)
        fetch(url)
            .then((response) => response.text(),
            function(err) {
                console.error(`Getting ${url}`);
                if(fallbackData) {
                    const data = fallbackData();
                    console.log('Using fallback data', data);
                    return data;
                }
                else
                    return {fail:true, err};
            })
            .then(function (text) {  
                if(typeof text === 'object' && text.fail){
                    console.error(text.err);
                    cb(text);
                    return;
                }
                text = text.trim();                      
                if(text.indexOf('{') === 0 || text.indexOf('[') === 0)
                    return JSON.parse(text);
                else
                    return text;
                // do something with the text response 
            })
            .then((json) => {
                if(!cb) {
                    console.log('no cb', cb);
                }
                else
                    cb(json);
            });
    }
}


  </script>
</body>
</html>
